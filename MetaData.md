# SQL Practice Project on Meta Data.
It includes the SQL queries during my learning process.

Database link: ```postgres://Test:bQNxVzJL4g6u@ep-noisy-flower-846766.us-east-2.aws.neon.tech/DA104.2``` \
It containd 4 tables:
1. ```meta_clients```
2. ```meta_employees```
3. ```meta_offsites```
4. ```meta_revenue```

### Question 1: What is the average annual revenue per sector of clients that work in the sectors Insurance and Banking?
- First we have make sure the data is clean. After looking into the ```sales_team```, ```industry```, ```sector```, and ```region``` column need to be either upper case or lowercase but not the mixed.
~~~~sql
SELECT
	UPPER(sector) AS sector,
  AVG(annual_revenue) AS avg_annual_rev_per_sector
FROM meta_clients
WHERE LOWER(sector) IN ('insurance', 'banking')
GROUP BY UPPER(sector);
~~~~

Output :
| sector    | avg_annual_rev_per_sector |
| --------- | ------------------------- |
| BANKING   | 1364.0833333333333        |
| INSURANCE | 355.4166666666667         |


### Question 2: Humberto wants to analyze the marketing spend percentage by country, but the data is not 100% clean. He mentions that you can clean the country field by using the sales team information, and shared the following mapping with you: 
### UK = United Kingdom
### FR = France
### ES = Spain
### IT = Italy
### DACH = Germany
### What is the average marketing spend percentage per country?
~~~~sql
SELECT
  CASE
  	WHEN mc.country IS NULL THEN (
      CASE
      	WHEN mc.sales_team LIKE ('%UK%') THEN 'United Kingdom'
      	WHEN mc.sales_team LIKE ('%FR%') THEN 'France'
    		WHEN mc.sales_team LIKE ('%ES%') THEN 'Spain'
    		WHEN mc.sales_team LIKE ('%IT%') THEN 'Italy'
    		WHEN mc.sales_team LIKE ('%DACH%') THEN 'Germany'
      END
      )
    ELSE mc.country
	END AS upd_country,
  AVG(mc.marketing_spend_perc) AS avg_marketing_spend_perc
FROM meta_clients AS mc
GROUP BY mc.sales_team, upd_country;
~~~~

OUTPUT :
| upd_country          | avg_marketing_spend_perc |
| -------------------- | ------------------------ |
| Morocco              | 0.08153846153846155      |
| United Kingdom       | 0.07259999999999998      |
| United Arab Emirates | 0.07307692307692307      |
| Italy                | 0.07279999999999998      |
| Spain                | 0.0716                   |
| France               | 0.07799999999999999      |
| Egypt                | 0.07375                  |
| Germany              | 0.07039999999999999      |
| Israel               | 0.08250000000000002      |


### Question 3: The data seems to be much cleaner now! Humberto is interested in comparing our revenue against the total marketing spend of the clients. What is the total marketing spend in $ (annual revenue of the client multiplied by marketing spend %) and the total revenue generated by Meta per country in 2022? Note: to correctly work with the annual revenue and marketing spend %, you will need to apply an aggregation function to the columns.
~~~~sql
SELECT
	CASE
  	WHEN mc.country IS NULL THEN (
      CASE
      	WHEN mc.sales_team LIKE ('%UK%') THEN 'United Kingdom'
      	WHEN mc.sales_team LIKE ('%FR%') THEN 'France'
    		WHEN mc.sales_team LIKE ('%ES%') THEN 'Spain'
    		WHEN mc.sales_team LIKE ('%IT%') THEN 'Italy'
    		WHEN mc.sales_team LIKE ('%DACH%') THEN 'Germany'
      END
      )
    ELSE mc.country
	END AS clean_country,
	MAX(mc.annual_revenue) * MAX(mc.marketing_spend_perc) AS total_marketing_spend,
  SUM(mr.revenue) AS total_rev
FROM meta_clients AS mc
LEFT JOIN meta_revenue AS mr
	ON mr.client_id = mc.client_id
WHERE EXTRACT(YEAR FROM mr.dates) = 2022
GROUP BY clean_country;
~~~~

OUTPUT :
| clean_country        | total_marketing_spend | total_rev          |
| -------------------- | --------------------- | ------------------ |
| Egypt                | 241.67000000000002    | 56.86926561580709  |
| France               | 1028.7                | 374.2308632098644  |
| Germany              | 1211.25               | 373.34815380462095 |
| Israel               | 224.28000000000003    | 126.08341063605788 |
| Italy                | 1878.75               | 367.0785631137588  |
| Morocco              | 1570.95               | 96.07374355504346  |
| Spain                | 1401.75               | 376.6474264808529  |
| United Arab Emirates | 1067.92               | 103.81707620357703 |
| United Kingdom       | 1459.5                | 373.9303546519519  |


#### Question 4: Create a client list and calculate the customer penetration % for clients in 2022 with an industry that matches consumer goods. The customer penetration can be calculated as follows: Meta revenue generated in one year divided by the marketing spend $ (from question 3) Show the clients with the lowest customer penetration first.
~~~~sql
SELECT
	mc.client_id,
	SUM(mr.revenue) / (MAX(mc.annual_revenue) * MAX(mc.marketing_spend_perc)) AS customer_pen
FROM meta_clients AS mc
INNER JOIN meta_revenue AS mr
	ON mr.client_id = mc.client_id
WHERE EXTRACT(YEAR FROM mr.dates) = 2022
	AND LOWER(mc.industry) LIKE ('%consumer goods%')
GROUP BY 1
ORDER BY 2;
~~~~

OUTPUT : (only first 10)
| client_id    | customer_pen         |
| ------------ | -------------------- |
| Client_1113  | 0.04750176073079562  |
| Client_9300  | 0.04927633646530191  |
| Client_37182 | 0.04954280803212278  |
| Client_31146 | 0.05082922457932033  |
| Client_2184  | 0.05999106397673829  |
| Client_2392  | 0.060028318241414504 |
| Client_7284  | 0.06400184536675155  |
| Client_4202  | 0.06903365387113054  |
| Client_32152 | 0.069997505298207    |
| Client_29128 | 0.07426794337815998  |
...
...
...


### Question 5: Humberto is looking to compare the customer penetration between the Financial Services and Retail & Consumer Goods industries. However, he knows that the industry data is a mess. Can you clean up the industry data and calculate the customer penetration for each industry based on the Meta revenue data from 2022? The following values should fall under Retail & Consumer Goods: retail, Retail, Consumer Goods, RCG, Retail & Consumer Goods.
~~~~sql
WITH tab_clean_ind AS(
  SELECT
  	client_id,
  	CASE
  		WHEN LOWER(industry) IN ('retail', 'consumer goods', 'rcg', 'retail %')
  			OR TRIM(LOWER(industry)) IN ('retail', 'consumer goods', 'rcg', 'retail %') THEN 'Retail & Consumer Goods'
    	WHEN LOWER(industry) IN ('financial services', 'finance') THEN 'Financial Services'
    	ELSE industry
    END AS clean_industry
	FROM meta_clients
  
  )
SELECT
	tci.clean_industry AS industry,
  SUM(mr.revenue) / (MAX(mc.annual_revenue) * MAX(mc.marketing_spend_perc)) AS customer_pen
FROM tab_clean_ind AS tci
LEFT JOIN meta_clients AS mc
	ON mc.client_id = tci.client_id
LEFT JOIN meta_revenue AS mr
	ON mr.client_id = mc.client_id
WHERE EXTRACT(YEAR FROM mr.dates) = 2022
GROUP BY clean_industry
ORDER BY customer_pen;
~~~~

OUTPUT :
| industry                           | customer_pen        |
| ---------------------------------- | ------------------- |
| Financial Services                 | 0.25620442250904635 |
| Manufacturing, Automotive & Energy | 0.3082337699109349  |
| Retail & Consumer Goods            | 0.7988291943126902  |


#### Question 6: Finally, Humberto is interested in understanding how the customer penetration % has changed year over year based on the changes in the revenue generated by Meta. We can assume that the annual revenue of the client remains consistent. Calculate the customer penetration % for every available year that we have Meta revenue available for all clients in the Banking sector.
~~~~sql
SELECT
	DISTINCT(EXTRACT(YEAR FROM mr.dates)) AS years,
	SUM(mr.revenue) / (MAX(mc.annual_revenue) * MAX(mc.marketing_spend_perc)) AS customer_pen
FROM meta_clients AS mc
LEFT JOIN meta_revenue AS mr
	ON mr.client_id = mc.client_id
WHERE LOWER(mc.sector) LIKE('banking')
GROUP BY years
ORDER BY years;
~~~~

OUTPUT :
| years | customer_pen         |
| ----- | -------------------- |
| 2018  | 0.029053275469894328 |
| 2019  | 0.04071750037094912  |
| 2020  | 0.053413112838933276 |
| 2021  | 0.06919113158284335  |
| 2022  | 0.09401236895084626  |
